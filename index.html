<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aptomat Web Control (·∫¢nh ƒë√£ cƒÉn ch·ªânh)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #121212;
            color: white;
            font-family: 'Inter', sans-serif;
            text-align: center;
            padding-top: 40px;
        }
        h2 { margin-bottom: 20px; font-weight: bold; font-size: 1.75rem; }
        .control-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin-bottom: 25px;
        }
        #btn {
            font-size: 24px;
            padding: 20px 60px;
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: 0.3s;
            font-weight: bold;
        }
        .on { background-color: #00c853; }
        .off { background-color: #555; }
        #checkBtn {
            background-color: #2196f3;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 500;
        }
        #statusSection { margin-top: 10px; }
        #circle {
            width: 30px; height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
            background-color: #555;
            box-shadow: 0 0 8px #222;
            transition: all 0.3s;
        }
        .circle-on { background-color: #00c853 !important; box-shadow: 0 0 15px #00e676; }
        .circle-off { background-color: #333 !important; box-shadow: 0 0 5px #111; }
      
        




      /* ‚≠ê V√ôNG CSS H√åNH ·∫¢NH S·∫†CH S·∫º (KH√îNG CH·ªàNH S·ª¨A V·ªä TR√ç) ‚≠ê */
#imageContainer {
    position: relative; 
    width: 300px; /* C·∫ßn ƒëi·ªÅu ch·ªânh theo k√≠ch th∆∞·ªõc ·∫£nh th·∫≠t */
    height: 300px; /* C·∫ßn ƒëi·ªÅu ch·ªânh theo k√≠ch th∆∞·ªõc ·∫£nh th·∫≠t */
    margin: 25px auto 0;
}
#offImage, #onImage {
    position: absolute; /* Gi·ªØ thu·ªôc t√≠nh n√†y ƒë·ªÉ ch·ªìng ·∫£nh */
    top: 0; 
    left: 0;
    width: 100%; 
    transition: opacity 0.3s;
}
#onImage {
     opacity: 0; /* ·∫¢nh ON m·∫∑c ƒë·ªãnh ·∫©n */
     /* ƒê√É B·ªé c√°c thu·ªôc t√≠nh left v√† top */
}
/* End - V√ôNG CSS H√åNH ·∫¢NH S·∫†CH S·∫º */
        






        #responseBox {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #444;
            width: 300px;
            margin-left: auto;
            margin-right: auto;
            font-weight: bold;
            background-color: #1e1e1e;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="max-w-xl mx-auto p-4">
        <h2 class="text-white">‚ö° Aptomat Web Control (·∫¢nh)</h2>

        <div class="control-section">
            <button id="checkBtn" onclick="getStatus()">Xem tr·∫°ng th√°i B·∫øp</button>
            <button id="btn" class="off" onclick="toggle()">M·ªû</button>
        </div>

        <div id="statusSection">
            <span id="circle" class="circle-off"></span>
            <span id="statusText">CB OFF</span>
         </div>

        <div id="imageContainer">
            <img id="offImage" src="bep_off.jpg" alt="B·∫øp T·∫Øt">
            <img id="onImage" src="bep_on.jpg" alt="B·∫øp B·∫≠t" style="opacity: 0;">
        </div>
        <div id="responseBox">Ph·∫£n h·ªìi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</div>
    </div>

    <script>
    const WORKER_URL = 'https://blynk-token-proxy.tanthanhlttb123.workers.dev'; 
    const VIRTUAL_PIN = "V1";
    let currentCommandState = 0; 
    
    // üîÑ H√†m t·ªïng h·ª£p c·∫≠p nh·∫≠t giao di·ªán
    function updateUI(state) {
        const isOn = state === 1;

        currentCommandState = state;
        const btn = document.getElementById("btn");
        btn.textContent = isOn ? "T·∫ÆT" : "M·ªû"; 
        btn.classList.toggle("on", isOn);
        btn.classList.toggle("off", !isOn);

        // C·∫≠p nh·∫≠t V√≤ng tr√≤n + Ch·ªØ
        const circle = document.getElementById("circle");
        const text = document.getElementById("statusText");
        circle.classList.toggle("circle-on", isOn);
        circle.classList.toggle("circle-off", !isOn);
        text.textContent = isOn ? "CB ON (B·∫øp ƒëang n·∫•u)" : "CB OFF (B·∫øp ƒë√£ t·∫Øt)";

        // ‚≠ê C·∫≠p nh·∫≠t H√¨nh ·∫¢nh (S·ª≠ d·ª•ng opacity) ‚≠ê
        const offImg = document.getElementById("offImage");
        const onImg = document.getElementById("onImage");
        
        offImg.style.opacity = isOn ? 0 : 1; 
        onImg.style.opacity = isOn ? 1 : 0;
        // End - C·∫≠p nh·∫≠t H√¨nh ·∫¢nh
    }

    // üîò G·ª≠i l·ªánh ON/OFF qua Worker
    async function toggle() {
        const responseBox = document.getElementById("responseBox");
        const newState = currentCommandState === 0 ? 1 : 0; 
        
        try {
            const res = await fetch(`${WORKER_URL}?action=update&pin=${VIRTUAL_PIN}&value=${newState}`);
                        
            if (res.ok) {
                updateUI(newState);
                responseBox.textContent = `‚úÖ G·ª≠i l·ªánh th√†nh c√¥ng (200 OK).`;
                responseBox.style.color = "green";
            } else {
                const errorText = await res.text();
                responseBox.textContent = `‚ùå L·ªñI K·∫æT N·ªêI: ${res.status}. ${errorText}`;
                responseBox.style.color = "red";
            }
        } catch (error) {
            responseBox.textContent = `‚ö†Ô∏è L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi Worker.`;
            responseBox.style.color = "orange";
        }
    }

    // üîÑ ƒê·ªçc tr·∫°ng th√°i hi·ªán t·∫°i t·ª´ Blynk qua Worker
    async function getStatus() {
        const responseBox = document.getElementById("responseBox");
        responseBox.textContent = `ƒêang t·∫£i tr·∫°ng th√°i hi·ªán t·∫°i...`;
        responseBox.style.color = "gray";

        try {
            const res = await fetch(`${WORKER_URL}?action=get&pin=${VIRTUAL_PIN}`);
            
            if (res.ok) {
                const rawValue = await res.text();
                const cleanValue = rawValue.replace(/[^0-9]/g, ''); 
                const state = (cleanValue === '1') ? 1 : 0; 
                
                updateUI(state);
                responseBox.textContent = `‚úÖ Tr·∫°ng th√°i th·ª±c t·∫ø: ${state === 1 ? 'ON' : 'OFF'}`;
                responseBox.style.color = "darkblue";

            } else {
                responseBox.textContent = `‚ùå L·ªói ƒë·ªçc tr·∫°ng th√°i: ${res.status}`;
                responseBox.style.color = "red";
            }
        } catch (error) {
            responseBox.textContent = `‚ö†Ô∏è L·ªói k·∫øt n·ªëi: Kh√¥ng th·ªÉ g·ªçi Worker.`;
            responseBox.style.color = "orange";
        }
    }

    // Kh·ªüi t·∫°o v√† ƒê·ªìng b·ªô h√≥a ƒë·ªãnh k·ª≥
    document.addEventListener('DOMContentLoaded', () => {
        getStatus();                 
        setInterval(getStatus, 10000); 

        document.getElementById("btn").addEventListener('click', toggle);
        document.getElementById("checkBtn").addEventListener('click', getStatus);
    });
    </script>
</body>
</html>

