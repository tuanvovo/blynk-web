<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aptomat Web Control (Blynk)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #121212;
            color: white;
            font-family: 'Inter', sans-serif;
            text-align: center;
            padding-top: 40px;
        }
        h2 { margin-bottom: 20px; font-weight: bold; font-size: 1.75rem; }
        .control-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin-bottom: 25px;
        }
        #btn {
            font-size: 24px;
            padding: 20px 60px;
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: 0.3s;
            font-weight: bold;
        }
        .on { background-color: #00c853; }
        .off { background-color: #555; }
        #checkBtn {
            background-color: #2196f3;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 500;
        }
        #statusSection { margin-top: 10px; }
        #circle {
            width: 30px; height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
            background-color: #555;
            box-shadow: 0 0 8px #222;
            transition: all 0.3s;
        }
        

         .circle-on { background-color: #00c853 !important; box-shadow: 0 0 15px #00e676; }
  .circle-off { background-color: #333 !important; box-shadow: 0 0 5px #111; }
.circle-off {
  background-color: #333 ;
  box-shadow: 0 0 5px #111 ;
}



        #bepEmoji {
            font-size: 150px; /* Thay th·∫ø h√¨nh ·∫£nh b·∫±ng emoji l·ªõn */
            display: block;
            margin: 25px auto 0;
            transition: transform 0.5s;
        }
        #responseBox {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #444;
            width: 300px;
            margin-left: auto;
            margin-right: auto;
            font-weight: bold;
            background-color: #1e1e1e;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <div class="max-w-xl mx-auto p-4">
        <h2 class="text-white">‚ö° Aptomat Web Control</h2>

        <!-- N√∫t ƒêi·ªÅu khi·ªÉn v√† N√∫t Tr·∫°ng th√°i -->
        <div class="control-section">
            <button id="checkBtn" onclick="getStatus()">Xem tr·∫°ng th√°i B·∫øp</button>
            <button id="btn" class="off" onclick="toggle()">OFF</button>
        </div>

        <!-- Tr·∫°ng th√°i v√≤ng tr√≤n + ch·ªØ -->
        <div id="statusSection">
            <span id="circle" class="circle-off"></span>
            <span id="statusText">CB OFF</span> 
        </div>

        <!-- Thay th·∫ø h√¨nh ·∫£nh b·∫øp b·∫±ng Emoji -->
        <div id="bepEmoji">‚ùÑÔ∏è</div>

        <div id="responseBox">Ph·∫£n h·ªìi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</div>
    </div>

<script>
    // ** L∆ØU √ù: VUI L√íNG D√ÅN BLYNK AUTH TOKEN C·ª¶A B·∫†N V√ÄO ƒê√ÇY **
    const TOKEN = "m8zkh8ZZUHvhBQBlan2yvT8ZYdNcaH0u"; 
    const API_BASE = "https://blynk.cloud/external/api";
    const VIRTUAL_PIN = 'V1'; 

    // Bi·∫øn ƒë·ªÉ l∆∞u tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa n√∫t ƒëi·ªÅu khi·ªÉn (0 ho·∫∑c 1)
    let currentCommandState = 0; 

    // üîò Nh·∫•n n√∫t ON/OFF (toggle)
    async function toggle() {
        const btn = document.getElementById("btn");
        // L·ªánh m·ªõi l√† ƒë·∫£o ng∆∞·ª£c tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa n√∫t (N·∫øu l√† OFF -> l·ªánh l√† 1)
        const newState = currentCommandState === 0 ? 1 : 0; 
        const responseBox = document.getElementById("responseBox");

        responseBox.textContent = "ƒêang g·ª≠i l·ªánh...";

        try {
            // G·ª≠i l·ªánh l√™n V1
            const res = await fetch(`${API_BASE}/update?token=${TOKEN}&${VIRTUAL_PIN}=${newState}`);

            if (res.ok) {
                responseBox.textContent = `‚úÖ L·ªánh ${newState === 1 ? 'ON' : 'OFF'} th√†nh c√¥ng (200 OK)`;
                
                // C·∫≠p nh·∫≠t ngay tr·∫°ng th√°i n√∫t ƒëi·ªÅu khi·ªÉn tr√™n UI (d√πng cho l·∫ßn nh·∫•n ti·∫øp theo)
                syncButtonUI(newState === 1); 

            } else {
                responseBox.textContent = `‚ö† Kh√¥ng h·ª£p l·ªá (L·ªói ${res.status})`;
            }
        } catch (e) {
            responseBox.textContent = "‚ùå L·ªói k·∫øt n·ªëi m·∫°ng!";
            console.error(e);
        }
    }

    // üîÑ Khi nh·∫•n ‚ÄúXem tr·∫°ng th√°i B·∫øp‚Äù
    async function getStatus() {
        const responseBox = document.getElementById("responseBox");
        responseBox.textContent = "ƒêang ƒë·ªçc tr·∫°ng th√°i b·∫øp...";

        try {
            // ƒê·ªçc gi√° tr·ªã V1 (Gi√° tr·ªã do ESP g·ª≠i l√™n)
            const res = await fetch(`${API_BASE}/get?token=${TOKEN}&${VIRTUAL_PIN}`);
            const value = await res.text();
            
            // X·ª≠ l√Ω gi√° tr·ªã nh·∫≠n ƒë∆∞·ª£c
            const isOn = value.trim() === "1";
            
            // 1. C·∫≠p nh·∫≠t v√≤ng tr√≤n v√† ch·ªØ
            updateStatus(isOn); 
            
            // 2. C·∫≠p nh·∫≠t Emoji B·∫øp (Thay th·∫ø h√¨nh ·∫£nh)
            updateImage(isOn);

            // 3. ƒê·ªìng b·ªô tr·∫°ng th√°i n√∫t ƒêi·ªÅu khi·ªÉn (T√πy ch·ªçn)
            const btn = document.getElementById("btn");
            const btnIsOn = currentCommandState === 1; // Tr·∫°ng th√°i l·ªánh hi·ªán t·∫°i
            
            // Ch·ªâ c·∫≠p nh·∫≠t n√∫t n·∫øu tr·∫°ng th√°i ƒë·ªçc ƒë∆∞·ª£c kh√°c tr·∫°ng th√°i n√∫t hi·ªán t·∫°i
            if (isOn !== btnIsOn) { 
                syncButtonUI(isOn);
            }
            
            responseBox.textContent = `ƒê·ªçc th√†nh c√¥ng: B·∫øp ƒëang ${isOn ? 'B·∫¨T' : 'T·∫ÆT'} (Gi√° tr·ªã V1: ${value.trim()})`;

        } catch (e) {
            responseBox.textContent = "‚ùå L·ªói ƒë·ªçc tr·∫°ng th√°i! ESP c√≥ ƒëang online kh√¥ng?";
            console.error("L·ªói ƒë·ªçc tr·∫°ng th√°i:", e);
        }
    }

    // ‚úÖ ƒê·ªìng b·ªô tr·∫°ng th√°i n√∫t sau khi g·ª≠i l·ªánh ho·∫∑c ƒë·ªçc tr·∫°ng th√°i
    function syncButtonUI(isOn) {
        // C·∫≠p nh·∫≠t bi·∫øn tr·∫°ng th√°i l·ªánh
        currentCommandState = isOn ? 1 : 0; 

        const btn = document.getElementById("btn");
        if (isOn) {
            btn.textContent = "ON";
            btn.classList.remove("off");
            btn.classList.add("on");
        } else {
            btn.textContent = "OFF";
            btn.classList.remove("on");
            btn.classList.add("off");
        }
    }

    // üîµ C·∫≠p nh·∫≠t v√≤ng tr√≤n + ch·ªØ (Tr·∫°ng th√°i V·∫≠t L√Ω th·ª±c t·∫ø)
    function updateStatus(isOn) {
         const circle = document.getElementById("circle");
        const text = document.getElementById("statusText");

         circle.classList.remove("circle-on","circle-off");
  circle.classList.add(isOn ? "circle-on" : "circle-off");
        
        text.textContent = isOn ? "CB ON (B·∫øp ƒëang n·∫•u üî•)" : "CB OFF (B·∫øp ƒë√£ t·∫Øt ‚ùÑÔ∏è)";
    }

    // üü† C·∫≠p nh·∫≠t bi·ªÉu t∆∞·ª£ng B·∫øp (Thay th·∫ø cho bep_on.jpg / bep_off.jpg)
    function updateImage(isOn) {
        const emojiDiv = document.getElementById("bepEmoji");
        emojiDiv.textContent = isOn ? "üî•" : "‚ùÑÔ∏è"; 
        emojiDiv.style.transform = isOn ? 'scale(1.1)' : 'scale(1.0)';
    }

    // Kh·ªüi t·∫°o tr·∫°ng th√°i n√∫t ban ƒë·∫ßu (Ch·ªâ cho giao di·ªán)
    document.addEventListener('DOMContentLoaded', () => {
        syncButtonUI(false); // Ban ƒë·∫ßu ƒë·∫∑t n√∫t ƒëi·ªÅu khi·ªÉn l√† OFF
    });
</script>
</body>
</html>
